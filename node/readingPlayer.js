"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.readingPlayer=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_objectSpread2=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_player=require("./player"),_eosjs=_interopRequireDefault(require("eosjs")),_wait=require("./utils/wait"),defaultConfig={account:{name:"eosio",authority:"active"},node:{keyProvider:["5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79sample"],chainId:"cf057bbfb72640471fd910bcb67639c22df9f92470936cddc1ade0e2f2e7dc4f",mockTransactions:function a(){return null},expireInSeconds:60,broadcast:!0,debug:!1,sign:!0,authorization:null// 该参数用于在多签名情况下，识别签名帐号与权限,格式如：account@permission
},urls:["https://mars.fn.eosbixin.com","https://eos.eoscafeblock.com","https://api.eosdublin.io","https://api.eosfengwo.com","https://eos.genesis-mining.com"]},readingPlayer=/*#__PURE__*/function(a){function b(){var a,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:defaultConfig.node,d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:defaultConfig.account,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:defaultConfig.urls;return(0,_classCallCheck2.default)(this,b),a=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(b).call(this)),a._conf=(0,_objectSpread2.default)({},defaultConfig.node,c),a._identity=(0,_objectSpread2.default)({},defaultConfig.account,d),a._urls=(0,_toConsumableArray2.default)(e),a._nodeConfigs=a._urls.map(function(b){var c={};for(var d in a._conf)a._conf.hasOwnProperty(d)&&(c[d]=a._conf[d]);return c.httpEndpoint=b,c}),console.log("[EosReading] ==> Create reading nodes \nCONFIGS:",JSON.stringify(a._nodeConfigs)),a._eosNodes=a._nodeConfigs.map(function(a){var b=(0,_eosjs.default)(a);return b.__conf=a,b}),a._head_block_num=0,a._head_retry_count=0,a}return(0,_inherits2.default)(b,a),(0,_createClass2.default)(b,[{key:"getIdentity",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",this._identity);case 1:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"setIdentity",value:function c(a,b){this._identity={name:a,authority:b}}},{key:"eosClient",get:function a(){if(!this._eosNodes||0>=this._eosNodes.length)throw new Error("EosUtil : No Avaliable Nodes.");return this._eosNodes[0]}}]),(0,_createClass2.default)(b,[{key:"checkNodes",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(){var b,c,d,e,f,g,h,j,k,l,m=arguments;return _regenerator.default.wrap(function(a){var i=Math.floor;for(;;)switch(a.prev=a.next){case 0:b=0<m.length&&void 0!==m[0]?m[0]:15e3,c=1<m.length&&void 0!==m[1]?m[1]:4,d=2<m.length&&void 0!==m[2]?m[2]:1e3;case 3:return a.next=6,(0,_wait.forMs)(b);case 6:console.log("[EosReading] ==> Start Checking Nodes ",this.eosClient.__conf.httpEndpoint,"AT",Date.now());case 7:return a.prev=8,a.next=11,this._eosNodes[0].getInfo({});case 11:if(e=a.sent,this._head_retry_count=0,e.head_block_num>this._head_block_num&&(this._head_block_num=e.head_block_num,console.log("[EosReading] ==> | Info : new head block num",this._head_block_num,"| Node: ",this.eosClient.__conf.httpEndpoint)),f=i(Math.random()*this._eosNodes.length),0!==f){a.next=17;break}return a.abrupt("break",65);case 17:return a.prev=17,console.log("[EosReading] ==> | Info : try pick another node by block height | Node: ",this._eosNodes[f].__conf.httpEndpoint),a.next=21,this._eosNodes[f].getInfo({});case 21:g=a.sent,g.head_block_num-this._head_block_num>d?(h=this._eosNodes[0],this._eosNodes[0]=this._eosNodes[f],this._eosNodes[f]=h,console.log("[EosReading] ==> | Info : new node selected (by head block) | OLD: ",h.__conf.httpEndpoint,"| NEW:",this.eosClient.__conf.httpEndpoint)):console.log("[EosReading] ==> | Info : no needs to switch node for block height | ",g.head_block_num,"-",this._head_block_num,"<",d),a.next=28;break;case 25:return a.prev=25,a.t0=a["catch"](17),a.abrupt("break",65);case 28:a.next=61;break;case 30:if(a.prev=30,a.t1=a["catch"](8),!(this._head_retry_count<c)){a.next=37;break}console.log("[EosReading] ==> | Error : Current node error | RETRY :",this._head_retry_count,"| NODE: ",this._eosNodes[0].__conf.httpEndpoint),this._head_retry_count+=1,a.next=61;break;case 37:console.log("[EosReading] ==> | Error : Current node error | RETRY : Failed | Node:",this._eosNodes[0].__conf.httpEndpoint),j=1;case 39:if(!(j<this._eosNodes.length)){a.next=61;break}return a.prev=40,a.next=43,this._eosNodes[j].getInfo({});case 43:if(k=a.sent,!(k.head_block_num>=this._head_block_num)){a.next=52;break}return l=this._eosNodes[0],this._eosNodes[0]=this._eosNodes[j],this._eosNodes[j]=l,console.log("[EosReading] ==> Info : new node selected | OLD: ",l.__conf.httpEndpoint,"| NEW:",this.eosClient.__conf.httpEndpoint),a.abrupt("break",61);case 52:console.log("[EosReading] ==> Info : test node passed | Node: ",this._eosNodes[j].__conf.httpEndpoint,"Test: ",k.head_block_num,"<",this._head_block_num);case 53:a.next=58;break;case 55:a.prev=55,a.t2=a["catch"](40),console.log("[EosReading] ==> Warning : test node error | Node: ",this._eosNodes[j].__conf.httpEndpoint);case 58:j++,a.next=39;break;case 61:return a.next=63,(0,_wait.forMs)(2e3);case 63:a.next=7;break;case 65:a.next=3;break;case 67:case"end":return a.stop();}},a,this,[[8,30],[17,25],[40,55]])}));return function b(){return a.apply(this,arguments)}}()}]),b}(_player.Player);exports.readingPlayer=readingPlayer;